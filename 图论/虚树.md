## 原理

在处理树上问题时，仅需要特定的几个关键点的信息，可以将原树信息浓缩，一般只需保留关键点及其两两 LCA，并且保持原有祖先关系不变。

## 构建

虚树的构建依靠下面这个性质：

> 关键点两两的 LCA 的集合 = 关键点 DFS 序相邻的 LCA 的集合

自证不难。

建立虚树可以看作是在模拟 DFS 虚树，用单调（DFS 序单调）栈维护一条从根节点到栈顶 $top$ 的路径。  
按 DFS 序升序枚举关键点 $p$，根据 $\mathrm{LCA}(top, p)$ 与 $top$ 的关系决定当前是**进入子树**还是**回溯**。

建虚树似乎还有一个简单的方法：把点按 dfs 序排序，相邻点的 lca 丢进去，再排序，每个点在虚树上的父亲就是自己和前驱的 lca。