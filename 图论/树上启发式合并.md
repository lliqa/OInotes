# 树上启发式合并 (DSU on tree)

### 引入

该算法处理一类**离线**树上问题，利用重链剖分的性质及长链剖分般巧妙的继承，实现以优秀的复杂度、简短的码量完美过题。

### 性质

重链剖分后树上任意一点到根的路径上的轻边数 $< \log_2 n$ 。

### 原理

首先将树进行重链剖分。  
由于询问已经离线，可以在 $\text{DFS}$ 的过程中处理问题。对于点 $x$，先处理其轻儿子并消除贡献，再处理重儿子并保留贡献。意义是继承重儿子的贡献，暴力计算轻儿子贡献。这样，如果累加单个点的贡献时间复杂度 $O(1)$，那么树上启发式合并就能以 $O(n \log_2 n)$ 的总时间复杂度实现。

### 复杂度证明

对于每个点，考虑其到根的路径，设有 $k$ 条轻边，则该点会被计算 $k + 1$ 次贡献（$k$ 次处于轻儿子子树中，$1$ 次在该点自身处）。  
根据性质，$k < \log_2 n$，则时间复杂度为 $O(nk) = O(n \log_2 n)$

### 应用

#### 子树众数

> 一棵 $n$ 个结点的树，每个点都有一个权值 $x$。子树众数为子树中出现次数最多的权值。  
> $x \leq 10^5$

DSU on tree 维护一个 $cnt(i)$，表示权值 $i$ 的出现次数即可。