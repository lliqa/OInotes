[TOC]

## 2019

### 回家路线

动态规划，但是对结点不好设状态，需要记录时间，考虑对边设 $f (i)$ 表示从 $1$ 走到 $i$ 号边的最小烦躁值。

转移方程有：

$$
f (i) = \min_{y_j = x_i, q_j \leq p_i} \{f_j + A (p_i - q_j)^2 + B(p_i - q_j) + C \}
$$

可以斜率优化。

在所有 $[1, n]$ 处维护下凸壳，按时间顺序处理，每条边在 $p$ 时刻丢到 $x$ 处凸壳询问，在 $q$ 时刻作为决策加入 $y$ 处凸壳。

### 机器人

机器人的可达范围和值的大小有关，考虑枚举极值大小 $x$ 及其位置 $p$，为了不重复计算同一序列，强制 $p$ 为 $x$ 最前\后出现的位置，这里强制 $p$ 为最后出现的位置，使得两侧的数一定不能跨过 $p$，并且 $p$ 能到全部位置，这样两侧就是独立的子问题，考虑用动态规划来描述，设 $f (l, r, x)$ 表示当前考察区间为 $[l, r]$，最大值为 $x$ 的合法序列数。  
枚举最大值 $x$ 的可能位置 $p$ 进行转移，方程为：

$$
f (l, r, x) = \sum_{ok (p)} \left( \sum_{i=1}^x f (l, p - 1, i)) \right) \left( \sum_{i=1}^{x-1} f (p+1, r, i - 1)) \right)
$$

考虑优化，从边界状态 $f (i, i, x)$ 入手，发现可以分成 3 段，每一段内 $f (i, i, x)$ 都是关于 $x$ 的 0 次函数，可得每一段内的前缀和是关于 $x$ 的 1 次函数。归纳可证 $f (l, r, x),\sum f (l, r, x)$ 均可分成若干段，每一段分别是 $r - l$ 次 和 $r - l + 1$ 次函数。

把所有的分段点 $A_i, B_i + 1$ 放到一起，得到若干连续的段 $[c_i, c_{i+1})$，所有状态 $f (l, r, x)$，在一段内都是关于 $x$ 的多项式。逐个段地求解所有 $f (l, r, x \in [c_i, c_{i+1}))$，每个段的所有状态只需求出前 $n + 1$ 个值然后插值，并把当前段求得的最终值赋给下一段的初值。  
有效状态数 $m$ 最大为 $2518$，复杂度为 $O(n^2m)$。

### 序列

建出费用流模型，观察发现有效的增广路种数 $=5$，维护每种的最优增广路模拟增广即可。

### 弹跳

KDT 优化建图 + Dijsktra。直接建图会爆空间，但完全可以隐式地访问图，每次在 KDT 上遍历找到能到的结点即可。

### 斗主地

每一次洗牌造成的贡献关系都是线性的，因此可以一轮一轮的算期望。

一个朴素的做法是直接一轮一轮动态规划，设 $f (x, y)$ 表示第一堆用了 $x$ 张，第二堆用了 $y$ 张的概率，转移显然，在转移过程顺便算期望就得到了每个位置的期望分数。

发现任意一个合法的洗牌序列概率相同，均等于 $\dfrac{X!Y!}{(X+Y)!}$。

设 $f (i, j)$ 表示经过前 $i$ 轮洗牌后 $j$ 位置的期望分数。
转移方程为：

$$
f (i, j) = \frac{1}{\binom{n}{a_i}} \left( \sum_{x = 1}^{a_i} \dbinom{i-1}{x-1}\dbinom{n-i}{a_i - x}f (x) + \sum_{x = a_i + 1}^{n} \dbinom{i-1}{x-a_i - 1}\dbinom{n-i}{n - x}f (x) \right)
$$

题目的特殊限制保证 $f (0, j) = j$ 或 $f (0, j) = j^2$。分别归纳可证 $f (x, j)$ 均为关于 $j$ 的一次或二次函数，用朴素做法求出前 3 个位置的期望分数，即可插值得到剩下位置的答案。

## 2020

### 美食家

考虑动态规划，设 $f (i, t)$ 表示 $t$ 时刻在 $i$ 号点的最大愉悦值。转移方程为 $f (i, t) = \max_{x = i, y, w} \{f (j, t - w) + c_i \}$。  
没有任何优化空间，时空复杂度双双爆炸。

边权 $w \leq 5$，启发思考，通过把每个点拆成 5 个点，再修改一下边来满足新图中所有边 $w = 1$。原先设计的状态第二维就能滚动优化，而每次的转移形式都是固定的，可以用一个 $(\max, +)$ 的变换矩阵描述。在美食节时特殊对举办点增加贡献即可。  
时间复杂度 $O((n5)^3\log T)$。

### 命运

题目保证所有路径 $(u, v)$ 满足 $u$ 是 $v$ 祖先。由此性质，把所有路径 $(u,v )$ 挂到 $v$ 处，可以自底向上确定边集，决策的影响范围只有祖先上的所有点。  
设 $f (i, d)$ 表示所有确定 $i$ 子树及 $i$ 父边（$i = 1$ 时忽略）的方案中，满足所有下端在 $i$ 子树且尚未合法的路径的上端深度 $max = d$ 的方案数，特殊定义 $d = 0$ 时所有路径合法。
转移方程分为两部分，首先合并所有 $son (i)$ 的状态，然后确定 $i$ 父边。

第一部分：

$$
f (i, d) = \sum_{\max \{d_j \} = d} \prod_{j \in son (i)} f (j, d_j)
$$

第二部分：

$$
f (i, 0) = \sum_d f (i, d)\\
f (i, dep_i - 1) = 0
$$

对于 $i$，有效的状态满足 $f (i, d)$ 满足 $d < dep_i - 1$。因为 $d \geq dep_i - 1$ 的状态 $i$ 不能变合法。

对于第一部分，可以线段树合并优化。

### 制作菜品

题目限制 $m \geq n - 2$， 从这里入手。
基本事实：$mk = \sum_{i=1}^n d_i$

规范化决策，将 $d_i$ 升序排列。

当 $m = n - 1$ 时，必定有解。
证明：

性质 1：$d_1 < k$。
证明 1：反证法，$d_1 \geq k \implies \sum d \geq nk > mk$，与基本事实矛盾，因此 $d_1 < k$，证毕。

性质 2：$n = 2$ 时 $d_1 + d_n \geq k$，$n > 2$ 时 $d_1 + d_n > k$。
证明 2：
前者显然。
当 $n > 2$ 时，反证法，$d_1 + d_n \leq k \implies d_i < k \implies \sum d < (n-2)k + k = mk$，因此 $d_1 + d_n > k$，证毕。

因此可以不断把 $d_1$ 全部和 $d_n$ 真部分做一道菜，归纳即证。

当 $m \geq n$ 时一定有 $d_n \geq k$，可以不断把 $d_n$ 单独做一道菜，归纳可得终止为 $m = n = 0$ 或 $m = n - 1$，必定有解。

综上可得 $m \geq n - 1$ 时必定有解，且均有构造方案。  
当 $m = n - 2$，大胆猜测有解 $\iff$ 能划分成两个 $m = n - 1$ 的部分。

证明：
充分性：显然。
必要性：  
具象化问题，用图论模型描述状态。原料为点，每道菜品的原料之间连一条边。总点数为 $n$，总边数为 $m = n - 2$。对于所有连通块满足 $m_i \geq n_i - 1$，因此该图一定存在两个以上连通块，并且一定存在连通块满足 $m_i = n_i - 1$。证毕。

考虑如何找到满足 $m = n - 1$ 的子集 $S$。一定满足 $\sum_{i \in S} d_i = (|S| - 1)k \implies \sum_{i \in S} (d_i - k) = -k$。

经典的背包问题，$d_i$ 升序后总值域范围为 $[-nk, -2k]$，整体偏移即可。
用 bitset 优化背包，复杂度为 $O(\frac{n^2k}{\omega})$。

### 超现实树

定义好树为满足所有结点的左右儿子大小较小值 $\leq 1$ 的树。

关键性质：$\operatorname{grow} (\mathscr{T})$ 几乎完备 $\iff$ 仅有有限个好树不能被生成。
证明：
* 必要性：显然。
* 充分性：任意一棵树都能由同深度的一棵好树生成，设有限个不能生成的好树中深度最大为 $x$，那么 $>x$ 的所有树都能生成，于是不能生成的树为有限个，得证。

题目转化为判断 仅有有限个好树不能被生成。  
注意到非好树不能替换得到好树，因此只需考虑所有给出的好树的生成集合 $\operatorname{grow} (\mathscr{S})$。如果只考虑所有好树，每个结点向下递归只有一个不平凡地方向。  

如何递归地判断仅有有限个好树不能被生成？
设 $\operatorname{Solve} (\mathscr{T})$ 表示判断好树树林 $\mathscr{T}$ 是否几乎完备。

把好树分成 4 类：
1. 根仅有左儿子 $\mathscr{T_0}$
2. 根仅有右儿子 $\mathscr{T_1}$
3. 根有左右儿子但右子树大小为 1 $\mathscr{T_2}$
4. 根有左右儿子但左子树大小为 1 $\mathscr{T_3}$

于是有 $\operatorname{Solve} (\mathscr{T}) = \land_{i=0}^3 \operatorname{Solve} (\mathscr{T_i})$。

## 2021

### 轻重边

转换题意，一次 操作一 相当于给链染上未出现过的颜色，操作二即询问链上满足端点颜色相同的边数。用重链剖分+线段树维护。

### 路径交点

LGV 引理的运用。

性质：一组路径的交点奇偶性与对应终点序列的逆序对数奇偶性相同。  
证明：考虑该组中任意两条路径 $(x, p_x)$ 和 $(y, p_y)$ 满足 $x < y$。两条路径每相交一次上下关系就会改变，因此如果 $p_x < p_y$ 那么相交偶数次，$p_x > p_y$ 时相交奇数次，恰好对应逆序对的奇偶。

根据上述性质，答案即为 $\sum_S \sigma (S)c(S)$，$S$ 为一组路径终点序列，$\sigma (S) = (-1)^{inv (S)}$，$inv (S)$ 为 $S$ 逆序对数，$c (S)$ 为 $S$ 对应的不相交路径组数。  
正好是 LGV 引理的适用形式。

### 庆典

题目只需要各点的连通性，考虑缩点后得到 DAG。由于题目的特殊性质，对于任意点 $x$，能到 $x$ 的点集内部构成一张竞赛图，缩点后得到链式结构，由于只需保留连通性，可以直接看作链。即 DAG 实际上由若干条链组成，且每条链只会有相同前缀，即为一棵树。  
现在图弱化为树，问题得到简化。  
发现满足 $s \to x \to t$ 的 $x$ 一定满足祖先和后代都存在 $s, t$ 或新增边的端点，即为这些点虚树上的点、边。建出虚树后从 $s$ 正向和 $t$ 反向遍历找到合法的 $x$ 即可。

### 量子通信

思考发现难以从加速查询方式入手。可以考虑缩小可能的答案范围。
题目限制满足 $k \leq 15$，而串长均为 $256$。可以将串分成 $16$ 段，每段长 $16$。根据鸽巢原理，答案串如果存在，一定有一段与询问串完全相同，这样就能缩小答案范围。又由于字典随机，期望复杂度正确。

### 密码箱

维护向量 $\begin{bmatrix}x\\y\end{bmatrix}$ 表示分数 $\dfrac{x}{y}$。函数 $f$ 可以表示成若干次线性变换，具体地，$\begin{bmatrix}x\\y\end{bmatrix}$ 经过 $a_i$ 的变换得到 $\begin{bmatrix}a_ix + y\\x\end{bmatrix}$，推知 $a_i$ 的变换为 $\begin{bmatrix}a_i&1\\1&0\end{bmatrix}$。并且 $\gcd (x, y) = 1$ 始终成立，因此不必考虑约分，可以正常取模。  
然后考虑操作序列，天真的想法是每次通过操作序列构造出数列，维护操作序列相同连续段之类的，但难以维护操作序列的变化。仍然考虑用线性变换描述每种操作 `W` 和 `E` 的影响。  
先分析 `W`，将 $a_n$ 增大 1，右乘 $\begin{bmatrix}1&0\\1&1\end{bmatrix}$ 即可。  
再分析 `E`，$a_n = 1$ 时两种变换都是相同的，可以全部进行 $a_n > 1$ 的变换，即 $a_n$ 减小 1，加入 $a_{n+1}= 1, a_{n + 2} = 1$，右乘 $\begin{bmatrix}2&1\\-1&0\end{bmatrix}$。

用平衡树维护区间总变换，反转总变换，翻转总变换，反翻总变换。

### 机器人游戏

样例解释告诉我可以对起点集合容斥。机器人执行操作序列相当于给出了 $X$ 和 $Y$ 对应位置的若干限制，共四种：0/1/不变/取反，一组 $\{(X_i, Y_i)\}$ 合法当且仅当对于所有 $(X, Y)$ 的所有位置，满足所有起点的限制。  

首先确定一个合适的计算贡献方式。对于一个确定的起点集合，机器人之间的贡献是独立的，一个纸条每一位是独立的。但纸条数量是 $O(n)$ 的，可以计算每一位所有机器人的贡献。

$n \leq 32$，考虑分治折半问题。  
对起点集合分治：
* 如果最靠后的起点 $\leq \frac{n}{2}$，可以枚举所有情况计算并用 bitset 优化，这一部分复杂度为 $O(\frac{2^\frac{n}{2} nm}{\omega})$。
* 如果最靠后的起点 $> \frac{n}{2}$，操作长度 $> \frac{n}{2}$ 的机器人都爆炸。DP 记录前 $\frac{n}{2}$ 是否有起点，暴力转移。同样用 bitset 优化预处理，这一部分复杂度为 $O(\frac{2^\frac{n}{2} nm}{\omega})$。